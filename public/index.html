<!DOCTYPE html>
<html>
<head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="./stylesheets/style.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
</head>
<body>
            <div class="container">
                <div class="topPanel">
                    <button id="button1" type="button" class="btn btn-primary">Primary</button>
                    <button id="button2" type="button" class="btn btn-danger">Secondary</button>
                    <button id="button3" type="button" class="btn btn-success">Success</button>
                </div>
                <div class="leftPanel" id="leftPanel"></div>
                <div class="splitLM" id="splitLM"></div>
                <div class="mainPanel" id="mainPanel">
                    <div class="SearchBar-Container">
                        <input id="Search" />
                        <div class="SearchBar-Container-Result" id="Search-Result">
                            <ul id="SearchList">
                            </ul>
                        </div>

                    </div>
                    <svg id="svg" class="svg" width="6000" height="6000"  style="visibility: hidden">
                        <!-- Shape will go here -->
                    </svg>
                </div>
                <div class="rightPanel" id="rightPanel"></div>
            </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="./javascripts/draggble.js"></script>
<script src="./javascripts/questionaire.js"></script>
<script>
    $('#mainPanel').scrollTop(3000);
    $('#mainPanel').scrollLeft(3000);

    let svg = document.getElementById("svg")
    svg.onmousemove= (e) =>myMove(e,svg)
    svg.onmouseup= myUp
    svg.onmousedown= (e)=>myDown(e,svg)
    //When click search from the search bar, will populate it here set prev to id
    $('ul').on('click',"li",function(){
        //alert($(this).html());
        //Draw new rectagle here.

        prev = $(this).attr('id')
        console.log("Get id:",prev)
        rects.push({
            x: 3000,
            y: 3000,
            width: 100,
            height: 100,
            fill: "#444444",
            isDragging: false,
            title:  $(this).html()
        });
        $("#SearchBar-Container").css("visibility","hidden")
        $("#Search").css("visibility","hidden")
        $("#Search-Result").css("visibility","hidden")
        $("#SearchList").css("visibility","hidden")
        $("#svg").css("visibility","visible")
        draw()
        return false;
    });


    //Search input here
    let click = false
    $("input").on('input', function (evt) {
        $("input").val(this.value)
        let searchSelector = $("#SearchList")
        searchSelector.empty()
        for(let i = 0; i < data.length; i++){
            if((data[i].q.toLowerCase()).match(this.value.toLowerCase())){
                searchSelector.append( "<li id="+data[i].id+">" + data[i].q + "</li>" );
            }
        }
        //If click on one of the question then hide search and searchSelector
        if(click) {
            $("#Search").css("visibility", "hidden")
            searchSelector.css("visibility", "hidden")
        }
        return false;
    });



    function populateRec(answer){
        console.log("Expand new rectangle: ",answer)
        let index
        let title
        //Here is the logic to expand question
        if(answer){
            index = data[prev].yes
            console.log("Index:",index)
            if(index === undefined) {
                index = data[prev].goto
            }
            title = data[index].q
        }
        else{
            index = data[prev].no

            if(index === undefined) {
                index = data[prev].goto
            }
            //Update title and index for the new rectangle
            title = data[index].q
        }
        rects.push({
            x: rects[rects.length-1].x + 100,
            y: rects[rects.length-1].y + 100,
            width: 100,
            height: 100,
            fill: "#444444",
            isDragging: false,
            title:  title
        });
        prev = index
        draw()
    }
    //Create a new rectangle here
    function append(){
        console.log("Append")
        rects.push({   x: 75 - 15,
            y: 50 - 15,
            width: 30,
            height: 30,
            fill: Math.round(0xffffff * Math.random()).toString(16),
            isDragging: false
        })
        $("svg").empty();
        var svgns = "http://www.w3.org/2000/svg";
        for(let i = 0; i < rects.length;i++) {
            var rect = document.createElementNS(svgns, 'rect'); //Create a path in SVG's namespace
            rect.setAttributeNS(null, 'x', rects[i].x.toString());
            rect.setAttributeNS(null, 'y', rects[i].y.toString());
            rect.setAttributeNS(null, 'height', rects[i].height.toString());
            rect.setAttributeNS(null, 'width', rects[i].width.toString());
            rect.setAttributeNS(null, 'fill', '#' + Math.round(0xffffff * Math.random()).toString(16));
            $("svg").append(rect);
        }
    }
    //Move SPLIT LM
    let dragSplit = false
    $("#splitLM").on('mousedown',function(evt){
        dragSplit = true
    })
    //Change the view of the main panel when move the left and main panel
    $("body").on('mousemove',function(evt) {
        console.log("Window Size",$(window).width())
        console.log("Mouse move")
        if (dragSplit) {
            $("#leftPanel").css('width',evt.clientX)
            $("#splitLM").css('left',evt.clientX)
            $("#mainPanel").css('left',evt.clientX + $("#splitLM").width())
            $("#mainPanel").css('width', $(window).width() - evt.clientX - $("#rightPanel").width())
            //$("#mainPanel").css('width',evt.clientX)
        }
    })

    $("body").on('mouseup',function(evt) {
        dragSplit = false
    })

</script>
</html>
