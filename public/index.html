<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./stylesheets/style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

</head>
<body>
<div class="container">


    <div class="topPanel" id="topPanel">
        <a href="/"><img src="cliexa-logo.png" alt="test" width="150" height="75"></a>
        <div class="progress" style="position:absolute;width:50%;right:10%;bottom:14px">
            <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
        </div>

        <div style="position:absolute;bottom:2px;right:10%;background-color: white;">


            <button type="button" class="btn btn-default btn-sm" id="zoom" onclick="zoomIn()">
                <span class="glyphicon glyphicon-zoom-in" ></span>
            </button>

            <button type="button" class="btn btn-default btn-sm" id="on-off" onclick="switchOnOff()" ><!-- Change style here -->
                Off
            </button>

            <button type="button" class="btn btn-default btn-sm" onclick="zoomOut()">
                <span class="glyphicon glyphicon-zoom-out"></span>
            </button>



        </div>

        <div class="home-button" style="position:absolute;width:10%;height:100%;right:0%;bottom:0%; background-color: white; border:1px solid white">
            <a href="/"><button type="button" class="btn btn-default btn-large" style="width:100%;height:100%"><!-- Change style here -->
                Home
            </button></a>
        </div>

    </div>
    <div class="leftPanel" id="leftPanel"></div>
    <div class="splitLM" id="splitLM"></div>
    <div class="draggable-mode" style="display:none;position: absolute;width:100px;height:100px;background-color:lightblue;top: 50%; right: 50%;transform: translate(50%,-50%);z-index: 1;opacity: 5">
        <button id="turnOffMessage" style="position: absolute;right:0%;" onclick="hideMessage()">X</button>
        <div id="message" >You entered focus mode</div>
    </div>


    <div class="mainPanel" id="mainPanel">

        <div class="package" id="package">

            <div class="sub-package borderline" id="Smoking">Smoking Cessation</div>
            <div class="sub-package borderline" id="PHQ9">Depression Assessment</div>
            <div class="sub-package borderline" id="GAD7">Anxiety Assessment</div>
            <div class="sub-package borderline" id="AUDIT">Alcohol Assessment</div>
            <div class="sub-package borderline" id="DAST-10">Drug Assessment</div>
            <div class="sub-package borderline" id="CCM">Chronic Care Management</div>

            <!--
            <div class="sub-package" id="GAD">GAD7</div>
            <div class="sub-package" id="DAST">DAST10</div>

            <div class="sub-package" id="NIDE">NIDE</div>
            <div class="sub-package" id="AUDIT">AUDIT</div>
            <div class="sub-package" id="DRAWING">DRAWING</div>
            <div class="sub-package" id="PDI">PDI</div>
            -->
        </div>

        <!-- Remove search bar for now
        <div class="SearchBar-Container" id="SearchBar-Container">
            <input id="Search" />
            <div class="SearchBar-Container-Result" id="Search-Result">
                <ul id="SearchList">
                </ul>
            </div>
        </div>
        -->

        <!--
        Previous values for viewBox is "0 0 1000000 1000000" width="1000000" height="1000000"
        -->
        <svg id="svg" xmlns="http://www.w3.org/2000/svg" class="shadow" viewBox="0 0 25000 800" width="25000" height="800" style="visibility: hidden;background-color: #f6f8f9; display: inline;" version="1.1">
            <!-- Using Jquery to add shape -->
        </svg>

    </div>

    <!--
    <div class="zoom" id="zoom">
        <button id="zoomIn" >Reset</button><br/>
    </div>
    -->
    <div class="rightPanel" id="rightPanel"></div>
</div>
</body>

<script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.5.0/dist/svg-pan-zoom.min.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="javascripts/Draggble.js"></script>
<script src="javascripts/Questionaire.js"></script>
<script src="javascripts/Configuration.js"></script>

<script src="javascripts/Main.js"></script>
<script src="javascripts/Rectangle.js"></script>
<script src="javascripts/RectangleSVG.js"></script>
<script src="javascripts/TextSVG.js"></script>
<script src="javascripts/LineSVG.js"></script>

<script>
    //This rectangle should be the first one ever
    //Config
    let config = new Configuration()
    let main   = new Main()
    let main_Draggble = new Draggble()
    config.setMainPanel(0,0)
    config.setSearchBar($('#mainPanel').width()/2 - $('#SearchBar-Container').width()/2,$('#mainPanel').height()/2 -  $('#SearchBar-Container').height()/2)
    var panZoom = window.panZoom = svgPanZoom('#svg', {
        zoomEnabled: true,
        controlIconsEnabled: true,
        dblClickZoomEnabled: false,
        panEnabled: false,
        mouseWheelZoomEnabled: false,
        minZoom: 0.1,
        beforeZoom: function(e){
        }
    });
    var selectedRectangle = new RectangleSVG()
    selectedRectangle.update_boxes(0,0,0,0,"#FFC433",0)
    //Listening to events
    let svg = document.getElementById("svg")
    svg.onmousemove= (e) => {
        if (config.getMode()){
            main_Draggble.myMove(e, svg)
        }
    }
    svg.onmouseup= (e) => {main_Draggble.myUp(e)}
    svg.onmousedown= (e)=> {
        if(config.getMode()) {
            main_Draggble.myDown(e, svg)
        }
    }
    svg.onwheel=(e) => {
        if(config.getMode()) {
            main_Draggble.myWheel(e, panZoom)
        }
    }

    //When click on a question => should populate this shape
    //When click search from the search bar, will populate it here set prev to id
    $('ul').on('click',"li",function(){
        //alert($(this).html());
        //Draw new rectagle here.

        //$("#SearchBar-Container").css("visibility","hidden")
        //$("#Search").css("visibility","hidden")
        //$("#Search-Result").css("visibility","hidden")
        //$("#SearchList").css("visibility","hidden")


        return false;
    });

    //$(".SearchBar-Container-Result").css("visibility","hidden")

    //Search input here
    /*
    let click = false
    $("input").on('input', function (evt) {
        $("input").val(this.value)
        let searchSelector = $("#SearchList")
        searchSelector.empty()
        for(let i = 0; i < data.length; i++){
            if((data[i].q.toLowerCase()).match(this.value.toLowerCase())){
                searchSelector.append( "<li id="+data[i].id+">" + data[i].q + "</li>" );
            }
        }
        if(this.value === ""){
            $(".SearchBar-Container-Result").css("visibility","hidden")
        }
        else{
            $(".SearchBar-Container-Result").css("visibility","visible")
        }
        //If click on one of the question then hide search and searchSelector
        if(click) {
            $("#Search").css("visibility", "hidden")
            searchSelector.css("visibility", "hidden")
        }
        return false;
    });
    */

    //Move SPLIT LM
    let dragSplit = false
    $("#splitLM").on('mousedown',function(evt){
        dragSplit = true
    })

    $("#splitLM").on('mouseup',function(evt){
        if(dragSplit){
            if(!config.getMode()) {
                //Call realign to focus on one rectangle at a time
                main.reAlign()
            }
        }
    })

    //Change the view of the main panel when move the left and main panel
    $("body").on('mousemove',function(evt) {
        if (dragSplit) {
            $("#leftPanel").css('width',evt.clientX)
            $("#splitLM").css('left',evt.clientX)
            $("#mainPanel").css('left',evt.clientX + $("#splitLM").width())
            $("#mainPanel").css('width', $(window).width() - evt.clientX - $("#rightPanel").width())
            //$("#mainPanel").css('width',evt.clientX)
        }
    })

    $("body").on('mouseup',function(evt) {
        dragSplit = false
    })
    //Listener for moving to previous state
    //Backtracking
    $("body").on('keydown', function(event) {
        if (event.ctrlKey && event.key === 'z') {
            let rects = config.getRects()
            if(rects.length > 1) {
                config.goBack(main.getFinal())
                main.setFinal(false)
                let left = $('#mainPanel').scrollLeft();
                $('#mainPanel').scrollLeft(left - $('#mainPanel').width());

            }
            else if(rects.length === 1){
                $('#mainPanel').scrollLeft(0);
                $('#mainPanel').scrollTop(0);
                //Clear everything!
                $("#svg").empty();
            }

            if(config.getTest_Progress_bar() >= 0) {
                $('#progress-bar').width(config.getCurrentLevel() + '%')
                $('#progress-bar').text(config.getCurrentLevel() + '%')
            }
        }
    });





    document.addEventListener ("keyup", function (event) {
        config.setCtrlKey(false)
    } );

    // If the letter "G" is pushed, unlocks the feature to zoom in or out.
    // If pressed again, locks the feature to zoom in or out.
    document.addEventListener ("keydown", function (event) {
        if(event.code === "KeyG"){
            if(!config.getMode()) {
               config.updateMode(true)
                panZoom.enableMouseWheelZoom()
            }
            else{
                config.updateMode(false)
                panZoom.disableMouseWheelZoom()
            }
        }
    } );

    $("#normal").click(function(){
        config.setScaleTranslate(1,1,1,1)
       //Redraw
    })

    // Detect click on components below
    // Detect if mouse is over Smoking box
    $("#Smoking").click(function() {
        //Hide all package
        $("#package").hide()
        config.updateQuestionPosition(0)
        let question = data[0].q
        main.insertShape(question)
        $("#svg").css("visibility","visible")

    }).mouseover(function(){
        $("#Smoking").css("width", "23%");
        $("#Smoking").css("height", "25%");
    }).mouseout(function() {
        $("#Smoking").css("width", "23%");
        $("#Smoking").css("height", "25%");
    });

    // Detect if mouse is over CCM box
    $("#CCM").click(function() {
        //Hide all package
        $("#package").hide()
        config.updateQuestionPosition(8)
        let question = data[8].q
        main.insertShape(question)
        $("#svg").css("visibility","visible")

    }).mouseover(function(){
        $("#CCM").css("width", "23%");
        $("#CCM").css("height", "25%");
    }).mouseout(function() {
        $("#CCM").css("width", "23%");
        $("#CCM").css("height", "25%");
    });

    // Detect if mouse is over Depression
    $("#PHQ9").click(function() {
        //Hide all package
        $("#package").hide()
        config.updateQuestionPosition(16)
        let question = data[16].q
        main.insertShape(question)
        $("#svg").css("visibility","visible")

    }).mouseover(function(){
        $("#PHQ9").css("width", "23%");
        $("#PHQ9").css("height", "25%");
    }).mouseout(function() {
        $("#PHQ9").css("width", "23%");
        $("#PHQ9").css("height", "25%");
    });

    // Detect if mouse is over anxiety
    $("#GAD7").click(function() {
        //Hide all package
        $("#package").hide()
        config.updateQuestionPosition(27)
        let question = data[27].q
        main.insertShape(question)
        $("#svg").css("visibility","visible")

    }).mouseover(function(){
        $("#GAD7").css("width", "23%");
        $("#GAD7").css("height", "25%");
    }).mouseout(function() {
        $("#GAD7").css("width", "23%");
        $("#GAD7").css("height", "25%");
    });


    // Detect if mouse is over alcohol assessment
    $("#AUDIT").click(function() {
        //Hide all package
        $("#package").hide()
        config.updateQuestionPosition(36)
        let question = data[36].q
        main.insertShape(question)
        $("#svg").css("visibility","visible")

    }).mouseover(function(){
        $("#AUDIT").css("width", "23%");
        $("#AUDIT").css("height", "25%");
    }).mouseout(function() {
        $("#AUDIT").css("width", "23%");
        $("#AUDIT").css("height", "25%");
    });

    // Detect if mouse is over drug assessment
    $("#DAST-10").click(function() {
        //Hide all package
        $("#package").hide()
        config.updateQuestionPosition(48)
        let question = data[48].q
        main.insertShape(question)
        $("#svg").css("visibility","visible")

    }).mouseover(function(){
        $("#DAST-10").css("width", "23%");
        $("#DAST-10").css("height", "25%");
    }).mouseout(function() {
        $("#DAST-10").css("width", "23%");
        $("#DAST-10").css("height", "25%");
    });

    // Below will be used for future questionnaires.
    // This is taken from the SOAPP Git package provided by Cliexa



    /*

    $("#DAST").mouseover(function(){
        $("#DAST").css("width", "50%");
        $("#DAST").css("height", "50%");
    }).mouseout(function() {
        $("#DAST").css("width", "23%");
        $("#DAST").css("height", "25%");
    });

    $("#NIDE").mouseover(function(){
        $("#NIDE").css("width", "50%");
        $("#NIDE").css("height", "50%");
    }).mouseout(function() {
        $("#NIDE").css("width", "23%");
        $("#NIDE").css("height", "25%");
    });

    $("#AUDIT").mouseover(function(){
        $("#AUDIT").css("width", "50%");
        $("#AUDIT").css("height", "50%");
    }).mouseout(function() {
        $("#AUDIT").css("width", "23%");
        $("#AUDIT").css("height", "25%");
    });

    $("#DRAWING").mouseover(function(){
        $("#DRAWING").css("width", "50%");
        $("#DRAWING").css("height", "50%");
    }).mouseout(function() {
        $("#DRAWING").css("width", "23%");
        $("#DRAWING").css("height", "25%");
    });

    $("#PDI").mouseover(function(){
        $("#PDI").css("width", "50%");
        $("#PDI").css("height", "50%");
    }).mouseout(function() {
        $("#PDI").css("width", "23%");
        $("#PDI").css("height", "25%");
    });

     */
    function switchOnOff(){
        //turnOffMessage
        //<div id="message" style="display: none">You enter draggable mode</div>
        if($("#on-off").html().includes("Off")){
            $("#message").html("You entered focus mode");
            $("#on-off").html("On")
            $(".draggable-mode").show()
            setTimeout(hideMessage, 1500);
            config.updateMode(true)
            panZoom.enableMouseWheelZoom()
            //You enter draggable mode
        }
        else{
            $("#message").html("You exited focus mode");
            $("#on-off").html("Off")
            $(".draggable-mode").show()
            config.updateMode(false)
            panZoom.disableMouseWheelZoom()
            setTimeout(hideMessage, 1500);
            //You exit draggable mode
        }

    }



    let scaleX = 1
    let scaleY = 1
    let translateX = 0
    let translateY = 0
    let flag = true
    let valueX
    let valueY



    $(document).ready(function () {
        $("svg").mousemove(function (e) {
           console.log("Mouse position:",e.offsetX,e.offsetY)
            //offsetX = e.offsetX
        });
    });

    function zoomIn(){
        console.log('matrix('+parseFloat(scaleX.toFixed(5))+ ', 0, 0, ' +parseFloat(scaleX.toFixed(5))+','+ parseFloat(translateX.toFixed(5)) +',' + parseFloat(translateY.toFixed(5)) + ")")

        var svg = document.getElementById('svg')
        var paths = svg.querySelectorAll('.svg-pan-zoom_viewport > rect,text,line');
        for(var i=0; i<paths.length; ++i) {
            paths[i].style.transform = 'matrix('+parseFloat(scaleX.toFixed(5))+ ', 0, 0, ' +parseFloat(scaleX.toFixed(5))+','+ parseFloat(translateX.toFixed(5)) +',' + parseFloat(translateY.toFixed(5)) + ")"
        }
        scaleX += 0.078257
        translateX -= valueX
        translateY -= valueY
        scaleX = Math.min(1,scaleX)
        scaleY = Math.max(1,scaleY)
    }
    function zoomOut(){
        //Engineer zoom in and out tomorrow.
        //Try to find the relationship between translate and scale and skew and rotate
        //

        console.log('matrix('+parseFloat(scaleX.toFixed(5))+ ', 0, 0, ' +parseFloat(scaleX.toFixed(5))+','+ parseFloat(translateX.toFixed(5)) +',' + parseFloat(translateY.toFixed(5)) + ")")
        if(flag){
            valueX = (offsetX + $('#mainPanel').width()/2)/13.05
            valueY = 15.5
            translateX = valueX
            translateY = valueY
            flag = false
            console.log("Offset of mouse position:", offsetX + 1024/2)
        }

        //('.svg-pan-zoom_viewport').css('transform','matrix(`${matrix[0]}`,`${matrix[3]}`,`${matrix[4]}`,`${matrix[5]}`');
        //$('.svg-pan-zoom_viewport').style.transform = 'matrix(0.44269, 0, 0, 0.44269, 310.394, 43.298)'
        //$('.svg-pan-zoom_viewport').css('transform','matrix('+matrix[0] +")'");
        //let svg = $("#svg")
        //$('.svg-pan-zoom_viewport').css('transform', 'translate(50 50) rotate(60)');
        //svg.style.transform = `scaleX(${matrix[0]})`;
        //$(".svg-pan-zoom_viewport").css("transform","translate(200,200)")
        //var mySVG = document.getElementById('svg');
        //mySVG.setAttribute("transform-origin", "0 0");
        //mySVG.setAttribute("transform", "scale(0.1 0.1)");//This will move svg
        //mySVG.setAttribute("transform", "skewX(40)");//This will move svg
        //mySVG.setAttribute("transform", "skewY(40)");//This will move svg
        var svg = document.getElementById('svg')
        var paths = svg.querySelectorAll('.svg-pan-zoom_viewport > rect,text,line');
        for(var i=0; i<paths.length; ++i) {
            //paths[i].style.scale = scaleX+ " " + scaleY;
            //paths[i].style.scale = '0.5 0.5'
            //paths[i].style.transform = "translate(" + translateX + "px,"+ translateY + "px)";
            //matrix(scaleX(),skewY(),skewX(),scaleY(),translateX(),translateY())
            /*
            scaleX -= 0.078257 , 0.072132, 0.066488, 0.061285
            scaleY -= 0.078257 , 0.072132, 0.066488, 0.061285
            translateX() += 37.4176
            translateY() += 10.8703
            Value: matrix(0.921743, 0, 0, 0.921743, 40.5944, 11.8781) Draggble.js:165:17
            Value: matrix(0.849611, 0, 0, 0.849611, 78.012, 22.7484) Draggble.js:165:17
            Value: matrix(0.783123, 0, 0, 0.783123, 112.501, 32.6897) Draggble.js:165:17
            Value: matrix(0.721838, 0, 0, 0.721838, 144.37, 42.0878) Draggble.js:165:17
            Value: matrix(0.665349, 0, 0, 0.665349, 173.588, 52.0809) Draggble.js:165:17
            Value: matrix(0.613281, 0, 0, 0.613281, 200.52, 61.2919)

            Value: matrix(0.921743, 0, 0, 0.921743, 40.7509, 11.252)
            Value: matrix(0.921743, 0, 0, 0.921743, 122.999, 11.4085)
            Value: matrix(0.921743, 0, 0, 0.921743, 280.373, 13.2084)
            Value: matrix(0.921743, 0, 0, 0.921743, 359.178, 13.0519)
            //Translate X will depend on the number of click
            */
            paths[i].style.transform = 'matrix('+parseFloat(scaleX.toFixed(5))+ ', 0, 0, ' +parseFloat(scaleX.toFixed(5))+','+ parseFloat(translateX.toFixed(5)) +',' + parseFloat(translateY.toFixed(5)) + ")"
        }
        scaleX -= 0.078257
        translateX += valueX
        translateY += valueY
        scaleX = Math.max(0.1,scaleX)
        scaleY = Math.max(0.1,scaleY)



    }
    function hideMessage(){
        $(".draggable-mode").hide()
    }


</script>
</html>
