<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./stylesheets/style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
</head>
<body>
<div class="container">


    <div class="topPanel" id="topPanel">
        <a href="/"><img src="cliexa-logo.png" alt="test" width="150" height="75"></a>
        <div class="progress" style="position:absolute;width:50%;right:10%;bottom:0">
            <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>
    <div class="leftPanel" id="leftPanel"></div>
    <div class="splitLM" id="splitLM"></div>
    <div class="mainPanel" id="mainPanel">
        <div class="package" id="package">
            <div class="sub-package" id="Smoking">Smoking Cessation</div>
            <div class="sub-package" id="CCM">Chronic Care Management</div>
            <!--
            <div class="sub-package" id="GAD">GAD7</div>
            <div class="sub-package" id="DAST">DAST10</div>

            <div class="sub-package" id="NIDE">NIDE</div>
            <div class="sub-package" id="AUDIT">AUDIT</div>
            <div class="sub-package" id="DRAWING">DRAWING</div>
            <div class="sub-package" id="PDI">PDI</div>
            -->
        </div>
        <!-- Remove search bar for now
        <div class="SearchBar-Container" id="SearchBar-Container">
            <input id="Search" />
            <div class="SearchBar-Container-Result" id="Search-Result">
                <ul id="SearchList">
                </ul>
            </div>
        </div>
        -->
        <svg id="svg" xmlns="http://www.w3.org/2000/svg" class="shadow" viewBox="0 0 100000 100000" width="100000" height="100000" style="visibility: hidden;background-color: #F6F8F9; display: inline;" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events">
            <!-- Using Jquery to add shape -->
        </svg>
    </div>

    <!--
    <div class="zoom" id="zoom">
        <button id="zoomIn" >Reset</button><br/>
    </div>
    -->
    <div class="rightPanel" id="rightPanel"></div>
</div>
</body>

<script src="https://ariutta.github.io/svg-pan-zoom/dist/svg-pan-zoom.min.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="javascripts/Draggble.js"></script>
<script src="javascripts/Questionaire.js"></script>
<script src="javascripts/Configuration.js"></script>

<script src="javascripts/Main.js"></script>
<script src="javascripts/Rectangle.js"></script>
<script src="javascripts/RectangleSVG.js"></script>
<script src="javascripts/TextSVG.js"></script>
<script src="javascripts/LineSVG.js"></script>

<script>
    //This rectangle should be the first one ever
    //Config
    let config = new Configuration()
    let main   = new Main()
    let main_Draggble = new Draggble()
    config.setMainPanel(0,0)
    config.setSearchBar($('#mainPanel').width()/2 - $('#SearchBar-Container').width()/2,$('#mainPanel').height()/2 -  $('#SearchBar-Container').height()/2)
    var panZoom = window.panZoom = svgPanZoom('#svg', {
        zoomEnabled: true,
        controlIconsEnabled: true,
        dblClickZoomEnabled: false,
        panEnabled: false,
        mouseWheelZoomEnabled: false,
        minZoom: 0.1,
        beforeZoom: function(e){
        }
    });
    var selectedRectangle = new RectangleSVG()
    selectedRectangle.update(0,0,0,0,"#FFC433",0)
    //Listening to events
    let svg = document.getElementById("svg")
    svg.onmousemove= (e) => {
        if (config.getMode()){
            main_Draggble.myMove(e, svg)
        }
    }
    svg.onmouseup= (e) => {main_Draggble.myUp(e)}
    svg.onmousedown= (e)=> {
        if(config.getMode()) {
            main_Draggble.myDown(e, svg)
        }
    }
    svg.onwheel=(e) => {
        if(config.getMode()) {
            main_Draggble.myWheel(e, panZoom)
        }
    }

    //When click on a question => should populate this shape
    //When click search from the search bar, will populate it here set prev to id
    $('ul').on('click',"li",function(){
        //alert($(this).html());
        //Draw new rectagle here.

        //$("#SearchBar-Container").css("visibility","hidden")
        //$("#Search").css("visibility","hidden")
        //$("#Search-Result").css("visibility","hidden")
        //$("#SearchList").css("visibility","hidden")


        return false;
    });

    //$(".SearchBar-Container-Result").css("visibility","hidden")

    //Search input here
    /*
    let click = false
    $("input").on('input', function (evt) {
        $("input").val(this.value)
        let searchSelector = $("#SearchList")
        searchSelector.empty()
        for(let i = 0; i < data.length; i++){
            if((data[i].q.toLowerCase()).match(this.value.toLowerCase())){
                searchSelector.append( "<li id="+data[i].id+">" + data[i].q + "</li>" );
            }
        }
        if(this.value === ""){
            $(".SearchBar-Container-Result").css("visibility","hidden")
        }
        else{
            $(".SearchBar-Container-Result").css("visibility","visible")
        }
        //If click on one of the question then hide search and searchSelector
        if(click) {
            $("#Search").css("visibility", "hidden")
            searchSelector.css("visibility", "hidden")
        }
        return false;
    });
    */

    //Move SPLIT LM
    let dragSplit = false
    $("#splitLM").on('mousedown',function(evt){
        dragSplit = true
    })

    $("#splitLM").on('mouseup',function(evt){
        if(dragSplit){
            if(!config.getMode()) {
                //Call realign to focus on one rectangle at a time
                main.reAlign()
            }
        }
    })

    //Change the view of the main panel when move the left and main panel
    $("body").on('mousemove',function(evt) {
        if (dragSplit) {
            $("#leftPanel").css('width',evt.clientX)
            $("#splitLM").css('left',evt.clientX)
            $("#mainPanel").css('left',evt.clientX + $("#splitLM").width())
            $("#mainPanel").css('width', $(window).width() - evt.clientX - $("#rightPanel").width())
            //$("#mainPanel").css('width',evt.clientX)
        }
    })

    $("body").on('mouseup',function(evt) {
        dragSplit = false
    })
    //Listening move to previous state
    $("body").on('keydown', function(event) {
        if (event.ctrlKey && event.key === 'z') {
            let rects = config.getRects()
            if(rects.length >= 1) {
                let test_progress_bar = config.getTest_Progress_bar()
                if(test_progress_bar >= 25) {
                    test_progress_bar -= 25
                }
                config.updateTest_Progress_Bar(test_progress_bar)
                let left = $('#mainPanel').scrollLeft();
                $('#mainPanel').scrollLeft(left - $('#mainPanel').width());
                main.clear()
                main.drawAll()
            }
            else{
                /*
                $("#SearchBar-Container").css("visibility","visible")
                $("#Search").css("visibility","visible")
                $("#Search-Result").css("visibility","visible")
                $("#SearchList").css("visibility","visible")
                $("#svg").css("visibility","hidden")
                 */
                $('#mainPanel').scrollLeft(0);
                $('#mainPanel').scrollTop(0);
            }

            if(config.getTest_Progress_bar() >= 0) {
                $('#progress-bar').width(config.getTest_Progress_bar() + '%')
                $('#progress-bar').text(config.getTest_Progress_bar() + '%')
            }
        }
    });



    $("#zoomIn").on('click',function (event) {
        console.log(panZoom.getZoom())
        // drawAll()
    })

    $("#zoomOut").on('click',function (event) {

        //drawAll()
    })


    document.addEventListener ("keyup", function (event) {
        config.setCtrlKey(false)
    } );

    // If the letter "G" is pushed, unlocks the feature to zoom in or out.
    // If pressed again, locks the feature to zoom in or out.
    document.addEventListener ("keydown", function (event) {
        if(event.code === "KeyG"){
            if(!config.getMode()) {
               config.updateMode(true)
                panZoom.enableMouseWheelZoom()
            }
            else{
                config.updateMode(false)
                panZoom.disableMouseWheelZoom()
            }
        }
    } );


    // Detect click on components below
    // Detect if mouse is over Smoking box
    $("#Smoking").click(function() {
        //Hide all package
        $("#package").hide()

        config.updateQuestionPosition(0)
        console.log("From search click...")
        main.drawTheShape("Do you smoke?")
        $("#svg").css("visibility","visible")

    }).mouseover(function(){
        $("#Smoking").css("width", "50%");+
        $("#Smoking").css("height", "50%");
    }).mouseout(function() {
        $("#Smoking").css("width", "23%");
        $("#Smoking").css("height", "25%");
    });

    // Detect if mouse is over CCM box
    $("#CCM").click(function() {
        //Hide all package
        $("#package").hide()

        config.updateQuestionPosition(7)
        console.log("From search click...")
        main.drawTheShape("Are you a returning patient?")
        $("#svg").css("visibility","visible")

    }).mouseover(function(){
        $("#CCM").css("width", "50%");
        $("#CCM").css("height", "50%");
    }).mouseout(function() {
        $("#CCM").css("width", "23%");
        $("#CCM").css("height", "25%");
    });


    // Below will be used for future questionnaires.
    // This is taken from the SOAPP Git package provided by Cliexa
    /*
    $("#GAD").mouseover(function(){
        $("#GAD").css("width", "0%");
        $("#GAD").css("height", "0%");
    }).mouseout(function() {
        $("#GAD").css("width", "23%");
        $("#GAD").css("height", "25%");
    });


    $("#DAST").mouseover(function(){
        $("#DAST").css("width", "50%");
        $("#DAST").css("height", "50%");
    }).mouseout(function() {
        $("#DAST").css("width", "23%");
        $("#DAST").css("height", "25%");
    });

    $("#NIDE").mouseover(function(){
        $("#NIDE").css("width", "50%");
        $("#NIDE").css("height", "50%");
    }).mouseout(function() {
        $("#NIDE").css("width", "23%");
        $("#NIDE").css("height", "25%");
    });

    $("#AUDIT").mouseover(function(){
        $("#AUDIT").css("width", "50%");
        $("#AUDIT").css("height", "50%");
    }).mouseout(function() {
        $("#AUDIT").css("width", "23%");
        $("#AUDIT").css("height", "25%");
    });

    $("#DRAWING").mouseover(function(){
        $("#DRAWING").css("width", "50%");
        $("#DRAWING").css("height", "50%");
    }).mouseout(function() {
        $("#DRAWING").css("width", "23%");
        $("#DRAWING").css("height", "25%");
    });

    $("#PDI").mouseover(function(){
        $("#PDI").css("width", "50%");
        $("#PDI").css("height", "50%");
    }).mouseout(function() {
        $("#PDI").css("width", "23%");
        $("#PDI").css("height", "25%");
    });

     */



</script>
</html>